<!DOCTYPE html>
<html lang="en" style="background:#171717;color:#FFFFFF;">
<head>
  <!-- CRITICAL: Paint dark + loader at the very first frame -->
  <style>
    html, body { margin:0; padding:0; background:#171717; color:#FFFFFF; }
    /* Loader renders IMMEDIATELY (before anything else) */
    #loader {
      position: fixed; inset: 0; background: #171717;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.4s ease;
    }
    .loader-bars { display: flex; gap: 6px; align-items: flex-end; height: 32px; }
    .loader-bars span { width: 4px; background: #FFFFFF; border-radius: 2px; animation: pulse-bar 1.2s ease-in-out infinite; }
    .loader-bars span:nth-child(1) { animation-delay: 0s; height: 16px; }
    .loader-bars span:nth-child(2) { animation-delay: 0.2s; height: 24px; }
    .loader-bars span:nth-child(3) { animation-delay: 0.4s; height: 20px; }
    @keyframes pulse-bar { 0%, 100% { transform: scaleY(0.5); opacity: 0.6 } 50% { transform: scaleY(1); opacity: 1 } }
    #loader.hide { opacity: 0; pointer-events: none; }
  </style>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#171717" />
  <meta name="color-scheme" content="dark only" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Lantern Player</title>

  <!-- Preload local Wavesurfer for faster first paint -->
  <link rel="preload" href="./wavesurfer.min.js" as="script" />

  <!-- Early: preload audio if present -->
  <script>
    (function () {
      try {
        const u = new URLSearchParams(location.search).get('audio');
        if (u) {
          const l = document.createElement('link');
          l.rel = 'preload'; l.as = 'audio'; l.href = u; l.crossOrigin = 'anonymous';
          document.head.appendChild(l);
        }
      } catch (e) {}
    })();
  </script>

  <style>
    :root{
      --bg:#171717; --text:#FFFFFF; --muted:#8c8c8c;
      --wave:#8a8a8a; --prog:#3a3a3a;
      --gutter:12px; --wave-h:96px;
      --chip:#232323; --chipText:#EAEAEA; --chipRing:#333;
    }
    html,body{
      background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      overflow:hidden; color:var(--text);
    }
    .wrap{
      width:100%; max-width:700px; margin:0 auto; padding:0 var(--gutter);
      box-sizing:border-box; opacity:0; transition:opacity .4s ease;
    }

    /* Waveform */
    #wave{ width:100%; height:var(--wave-h); background:transparent; border-radius:12px; overflow:hidden; }
    #wave canvas { background:#171717; display:block; } /* defend iOS white canvas */

    .footerRow{ display:flex; align-items:center; justify-content:space-between; margin-top:12px; gap:10px; }
    .time{ font-size:12px; color:var(--muted); letter-spacing:.2px; min-width:42px; }
    .controls{ flex:1; display:flex; justify-content:center; align-items:center; }

    /* Play button — static white ring, no hover/touch shifts */
    .playbtn{
      width:64px; height:64px; border-radius:50%;
      background:var(--bg); border:2px solid #FFFFFF;
      display:grid; place-items:center; cursor:pointer; outline:none; -webkit-tap-highlight-color:transparent;
    }
    .playbtn svg{ width:24px; height:24px; fill:#FFFFFF; }
    .playbtn:focus, .playbtn:hover, .playbtn:active{ border-color:#FFFFFF; background:var(--bg); }

    /* ─────────────────────────────
       Lyrics chip + panel (collapsed by default)
       ───────────────────────────── */
    .lyrics-toggle{
      margin-top:16px; display:flex; justify-content:center;
    }
    .chip{
      background:var(--chip); color:var(--chipText); border:1px solid var(--chipRing);
      padding:8px 12px; border-radius:999px; font-size:12px; letter-spacing:.2px;
      display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none;
    }
    .chip svg{ width:14px; height:14px; fill:var(--chipText); opacity:.85; }

    .lyrics-panel{
      max-height:0; overflow:hidden; transition:max-height .28s ease, opacity .18s ease;
      opacity:0; margin-top:6px;
    }
    .lyrics-panel.open{ max-height:240px; opacity:1; }

    .lyrics{
      margin-top:12px; text-align:center; font-size:14px; line-height:1.6;
      color:#8c8c8c; padding-bottom:4px; overflow:auto; max-height:220px; scrollbar-width:thin;
    }
    .lyrics .line{ opacity:.45; transition:opacity .2s ease, color .2s ease; }
    .lyrics .line.active{ opacity:1; color:#fff; font-weight:500; }

    /* Optional small caption */
    .lyrics-caption{
      color:#7a7a7a; font-size:11px; text-align:center; margin-top:6px;
    }

    @media (max-width:360px){
      :root{ --wave-h:88px; }
      .playbtn{ width:58px; height:58px; } .playbtn svg{ width:22px; height:22px; }
      .lyrics-panel.open{ max-height:200px; }
    }
  </style>
</head>
<body>
  <!-- Loader with pulsing sound bars -->
  <div id="loader">
    <div class="loader-bars"><span></span><span></span><span></span></div>
  </div>

  <div class="wrap">
    <div id="wave"></div>

    <div class="footerRow">
      <div id="tLeft" class="time">0:00</div>
      <div class="controls">
        <button id="toggle" class="playbtn" aria-label="Play / Pause">
          <svg viewBox="0 0 24 24" id="icon"><path d="M8 5v14l11-7z"/></svg>
        </button>
      </div>
      <div id="tRight" class="time">0:00</div>
    </div>

    <!-- Lyrics toggle chip -->
    <div class="lyrics-toggle">
      <div class="chip" id="lyricsChip">
        <svg viewBox="0 0 24 24"><path d="M12 3v18M3 12h18"/></svg>
        Lyrics
      </div>
    </div>

    <!-- Collapsible lyrics panel -->
    <div class="lyrics-panel" id="lyricsPanel">
      <div class="lyrics" id="lyrics"></div>
      <div class="lyrics-caption">karaoke preview • demo text</div>
    </div>
  </div>

  <audio id="media" preload="auto" playsinline></audio>

  <script src="./wavesurfer.min.js"></script>
  <script>
    /* ========== Player bootstrap ========== */
    const params    = new URLSearchParams(location.search);
    const AUDIO_URL = params.get('audio') || './demo.mp3';

    const media = document.getElementById('media');
    media.src = AUDIO_URL;
    media.crossOrigin = 'anonymous';

    const ws = WaveSurfer.create({
      container:'#wave', media, backend:'MediaElement',
      height: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--wave-h')),
      waveColor:'#8a8a8a', progressColor:'#3a3a3a',
      cursorColor:'rgba(255,255,255,.3)', barWidth:2, barGap:1,
      normalize:true, responsive:true, dragToSeek:true, fillParent:true
    });

    const fmt = s => (!isFinite(s) ? '0:00' : `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`);
    const tLeft=document.getElementById('tLeft'), tRight=document.getElementById('tRight');
    const wrap = document.querySelector('.wrap');
    ws.on('ready', ()=> {
      const d = ws.getDuration() || media.duration || 0;
      tLeft.textContent = '0:00'; tRight.textContent = fmt(d);
      wrap.style.opacity = '1';
      document.getElementById('loader').classList.add('hide');
    });
    ws.on('audioprocess', ()=> tLeft.textContent = fmt(ws.getCurrentTime()));
    ws.on('seek',        ()=> tLeft.textContent = fmt(ws.getCurrentTime()));

    /* ========== Controls ========== */
    const btn = document.getElementById('toggle');
    const icon = document.getElementById('icon');
    function syncIcon(){
      icon.innerHTML = media.paused
        ? '<path d="M8 5v14l11-7z"/>'
        : '<path d="M6 5h4v14H6zm8 0h4v14h-4z"/>';
    }
    btn.onclick = ()=> { ws.playPause(); syncIcon(); };
    media.addEventListener('play',  syncIcon);
    media.addEventListener('pause', syncIcon);
    addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); btn.click(); } });

    /* ========== Premium Lyrics UX (toggle + karaoke) ========== */

    // 1) Toggle chip
    const chip   = document.getElementById('lyricsChip');
    const panel  = document.getElementById('lyricsPanel');
    chip.addEventListener('click', ()=> panel.classList.toggle('open'));

    // 2) Fake lyric data (per-line with optional per-word timings)
    // Each entry can be either:
    //  { time, text }  → line-level highlight
    //  { time, words:[ {t, w}, ... ] } → karaoke per-word within that line (t = offset from line time)
    const lyricsData = [
      { time: 0,  words: [
        { t: 0.00, w: "When" }, { t: 0.30, w: "the" }, { t: 0.45, w: "city" }, { t: 0.80, w: "wakes" },
        { t: 1.20, w: "in" }, { t: 1.35, w: "silver" }, { t: 1.80, w: "light" }
      ]},
      { time: 4,  text: "And echoes fill the streets again" },
      { time: 8,  text: "I chase the rhythm through the night" },
      { time: 12, words: [
        { t: 0.00, w: "Until" }, { t: 0.35, w: "the" }, { t: 0.50, w: "noise" }, { t: 0.95, w: "becomes" },
        { t: 1.40, w: "my" }, { t: 1.55, w: "friend" }
      ]},
      { time: 17, text: "Hold me close, the world feels small" },
      { time: 21, text: "Every heartbeat says it all" },
      { time: 26, text: "We could run till morning calls" },
      { time: 30, text: "In this glow we never fall" }
    ];

    // 3) Render lyrics (supports per-word markup for karaoke)
    const lyricsEl = document.getElementById('lyrics');
    function renderLyrics(){
      lyricsEl.innerHTML = lyricsData.map((ln)=> {
        if (ln.words){
          const inner = ln.words.map(w => `<span class="w" data-off="${w.t}">${w.w}</span>`).join(' ');
          return `<div class="line" data-time="${ln.time}" data-mode="words">${inner}</div>`;
        }
        return `<div class="line" data-time="${ln.time}" data-mode="line">${ln.text}</div>`;
      }).join('');
    }
    renderLyrics();

    const lineEls = Array.from(document.querySelectorAll('.lyrics .line'));
    function currentLineIndex(cur){
      let idx = 0;
      for (let i=0;i<lyricsData.length;i++) if (cur >= lyricsData[i].time) idx = i;
      return idx;
    }

    function tickLyrics(cur){
      const idx = currentLineIndex(cur);
      lineEls.forEach((el,i)=> el.className = 'line' + (i===idx ? ' active' : ''));

      // scroll active near center
      const active = lineEls[idx];
      if (active) lyricsEl.scrollTo({ top: active.offsetTop - 60, behavior: 'smooth' });

      // karaoke per-word (only if this line has words)
      const ln = lyricsData[idx];
      if (ln && ln.words){
        const lineStart = ln.time;
        const rel = Math.max(0, cur - lineStart);
        const wordSpans = active.querySelectorAll('.w');
        wordSpans.forEach(span => {
          const off = parseFloat(span.dataset.off || '0');
          span.style.opacity = rel >= off ? '1' : '.45';
        });
      }
    }

    ws.on('audioprocess', ()=> tickLyrics(ws.getCurrentTime()));
    ws.on('seek',        ()=> tickLyrics(ws.getCurrentTime()));

  </script>
</body>
</html>
