<!DOCTYPE html>
<html lang="en" style="background:#171717;color:#FFFFFF;">
<head>
  <!-- CRITICAL: Paint dark + loader at the very first frame -->
  <style>
    html, body { 
      margin:0; 
      padding:0; 
      background:#171717; 
      color:#FFFFFF; 
    }
    
    /* Loader renders IMMEDIATELY (before anything else) */
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #171717;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }
    
    /* Pulsing sound bars loader */
    .loader-bars { display: flex; gap: 6px; align-items: flex-end; height: 32px; }
    .loader-bars span { width: 4px; background: #FFFFFF; border-radius: 2px; animation: pulse-bar 1.2s ease-in-out infinite; }
    .loader-bars span:nth-child(1) { animation-delay: 0s;   height: 16px; }
    .loader-bars span:nth-child(2) { animation-delay: 0.2s; height: 24px; }
    .loader-bars span:nth-child(3) { animation-delay: 0.4s; height: 20px; }
    @keyframes pulse-bar {
      0%, 100% { transform: scaleY(0.5); opacity: 0.6; }
      50% { transform: scaleY(1); opacity: 1; }
    }
    
    /* Hide loader when ready */
    #loader.hide { opacity: 0; pointer-events: none; }
  </style>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#171717" />
  <meta name="color-scheme" content="dark only" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Lantern Player</title>

  <!-- Preload local Wavesurfer for faster first paint -->
  <link rel="preload" href="./wavesurfer.min.js" as="script" />

  <!-- Early: if ?audio= is present, start preloading the audio bytes -->
  <script>
    (function () {
      try {
        const u = new URLSearchParams(location.search).get('audio');
        if (u) {
          const l = document.createElement('link');
          l.rel = 'preload'; l.as = 'audio'; l.href = u; l.crossOrigin = 'anonymous';
          document.head.appendChild(l);
        }
      } catch (e) {}
    })();
  </script>

  <style>
    :root{
      --bg:#171717;
      --text:#FFFFFF;
      --muted:#8c8c8c;
      --wave:#8a8a8a;
      --prog:#3a3a3a;

      --gutter:12px;
      --wave-h:96px;
    }

    html,body{
      background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      overflow:hidden;
      color:var(--text);
    }

    .wrap{
      width:100%;
      max-width:700px;
      margin:0 auto;
      padding:0 var(--gutter);
      box-sizing:border-box;
      opacity:0;
      transition: opacity 0.4s ease;
    }

    #wave{
      width:100%;
      height:var(--wave-h);
      background:transparent;
      border-radius:12px;
      overflow:hidden;
    }
    #wave canvas { background-color:#171717; display:block; }

    .footerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
      gap:10px;
    }

    .time{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
      min-width:42px;
    }

    .controls{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .playbtn{
      width:64px;
      height:64px;
      border-radius:50%;
      background:var(--bg);
      border:2px solid #FFFFFF;
      display:grid;
      place-items:center;
      cursor:pointer;
      outline:none;
      -webkit-tap-highlight-color: transparent;
    }
    .playbtn svg{
      width:24px; height:24px; fill:#FFFFFF;
    }
    .playbtn:focus, .playbtn:hover, .playbtn:active{
      border-color:#FFFFFF; background:var(--bg);
    }

    @media (max-width:360px){
      :root{ --wave-h:88px; }
      .playbtn{ width:58px; height:58px; }
      .playbtn svg{ width:22px; height:22px; }
    }

    /* ========== PREMIUM LYRICS ========== */
    
    /* Toggle button - minimal and elegant */
    .lyricsToggle{
      margin-top:20px;
      text-align:center;
    }
    .lyricsToggle button{
      background:transparent;
      border:none;
      color:#8c8c8c;
      font-size:13px;
      cursor:pointer;
      padding:8px 16px;
      border-radius:20px;
      transition:all 0.2s ease;
      font-family:inherit;
      letter-spacing:0.3px;
      outline:none;
      -webkit-tap-highlight-color: transparent;
    }
    .lyricsToggle button:hover{
      color:#FFFFFF;
      background:rgba(255,255,255,0.05);
    }
    .lyricsToggle button:active{
      transform:scale(0.96);
    }

    /* Lyrics container - slides open */
    .lyricsContainer{
      margin-top:16px;
      max-height:0;
      overflow:hidden;
      transition:max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      position:relative;
    }
    .lyricsContainer.open{
      max-height:200px;
    }

    /* Scrollable lyrics area with gradient masks */
    .lyricsScroll{
      height:200px;
      overflow-y:auto;
      overflow-x:hidden;
      position:relative;
      padding:40px 0;
      scrollbar-width:none; /* Firefox */
      -ms-overflow-style:none; /* IE/Edge */
    }
    .lyricsScroll::-webkit-scrollbar{
      display:none; /* Chrome/Safari */
    }

    /* Gradient masks for elegant fade */
    .lyricsScroll::before,
    .lyricsScroll::after{
      content:'';
      position:absolute;
      left:0;
      right:0;
      height:60px;
      pointer-events:none;
      z-index:2;
    }
    .lyricsScroll::before{
      top:0;
      background:linear-gradient(to bottom, #171717 0%, transparent 100%);
    }
    .lyricsScroll::after{
      bottom:0;
      background:linear-gradient(to top, #171717 0%, transparent 100%);
    }

    /* Individual lyric lines */
    .lyricLine{
      text-align:center;
      padding:12px 20px;
      transition:all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      cursor:pointer;
      font-size:15px;
      line-height:1.5;
      color:#5a5a5a;
      opacity:0.4;
      transform:scale(0.92);
      user-select:none;
      -webkit-user-select:none;
    }

    /* Current line - PREMIUM karaoke style */
    .lyricLine.active{
      font-size:19px;
      font-weight:600;
      color:#FFFFFF;
      opacity:1;
      transform:scale(1);
      letter-spacing:0.3px;
    }

    /* Next line preview */
    .lyricLine.next{
      color:#8c8c8c;
      opacity:0.6;
      transform:scale(0.96);
    }

    /* Hover effect for tap-to-seek */
    .lyricLine:hover{
      color:#FFFFFF;
      opacity:0.8;
      transform:scale(0.98);
    }

    /* Empty state */
    .lyricsEmpty{
      text-align:center;
      padding:60px 20px;
      color:#5a5a5a;
      font-size:14px;
      font-style:italic;
    }
  </style>
</head>
<body>
  <!-- Loader with pulsing sound bars -->
  <div id="loader">
    <div class="loader-bars">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="wrap">
    <!-- Player (untouched) -->
    <div id="wave"></div>

    <div class="footerRow">
      <div id="tLeft" class="time">0:00</div>
      <div class="controls">
        <button id="toggle" class="playbtn" aria-label="Play / Pause">
          <svg viewBox="0 0 24 24" id="icon"><path d="M8 5v14l11-7z"/></svg>
        </button>
      </div>
      <div id="tRight" class="time">0:00</div>
    </div>

    <!-- Lyrics toggle button -->
    <div class="lyricsToggle">
      <button id="lyricsBtn">Show Lyrics</button>
    </div>

    <!-- Lyrics container (slides open) -->
    <div class="lyricsContainer" id="lyricsContainer">
      <div class="lyricsScroll" id="lyricsScroll">
        <!-- Lines injected here -->
      </div>
    </div>
  </div>

  <audio id="media" preload="auto" playsinline></audio>

  <script src="./wavesurfer.min.js"></script>
  <script>
    const params    = new URLSearchParams(location.search);
    const AUDIO_URL = params.get('audio') || './demo.mp3';

    const media = document.getElementById('media');
    media.src = AUDIO_URL;
    media.crossOrigin = 'anonymous';

    const ws = WaveSurfer.create({
      container:'#wave',
      media,
      backend:'MediaElement',
      height: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--wave-h')),
      waveColor:getComputedStyle(document.documentElement).getPropertyValue('--wave').trim(),
      progressColor:getComputedStyle(document.documentElement).getPropertyValue('--prog').trim(),
      cursorColor:'rgba(255,255,255,.3)',
      barWidth:2,
      barGap:1,
      normalize:true,
      responsive:true,
      dragToSeek:true,
      fillParent:true
    });

    const fmt = s => (!isFinite(s)
      ? '0:00'
      : `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`);

    const tLeft  = document.getElementById('tLeft');
    const tRight = document.getElementById('tRight');
    const wrap   = document.querySelector('.wrap');

    ws.on('ready', ()=>{
      const dur = ws.getDuration() || media.duration || 0;
      tLeft.textContent  = '0:00';
      tRight.textContent = fmt(dur);
      wrap.style.opacity = '1';
      document.getElementById('loader').classList.add('hide');
    });

    ws.on('audioprocess', ()=>{ tLeft.textContent = fmt(ws.getCurrentTime()); });
    ws.on('seek',        ()=>{ tLeft.textContent = fmt(ws.getCurrentTime()); });

    const btn  = document.getElementById('toggle');
    const icon = document.getElementById('icon');
    function syncIcon(){
      icon.innerHTML = media.paused
        ? '<path d="M8 5v14l11-7z"/>'
        : '<path d="M6 5h4v14H6zm8 0h4v14h-4z"/>';
    }
    btn.onclick = ()=>{ ws.playPause(); syncIcon(); };
    media.addEventListener('play',  syncIcon);
    media.addEventListener('pause', syncIcon);
    addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); btn.click(); } });

    /* ========== PREMIUM LYRICS LOGIC ========== */

    // Demo timestamped lyrics
    const lyrics = [
      { time: 0,  text: "When the city wakes in silver light" },
      { time: 4,  text: "And echoes fill the streets again" },
      { time: 8,  text: "I chase the rhythm through the night" },
      { time: 12, text: "Until the noise becomes my friend" },
      { time: 17, text: "Hold me close, the world feels small" },
      { time: 21, text: "Every heartbeat says it all" },
      { time: 26, text: "We could run till morning calls" },
      { time: 30, text: "In this glow we never fall" },
      { time: 35, text: "Stars are fading, dawn arrives" },
      { time: 39, text: "But we keep dancing through the night" }
    ];

    const lyricsBtn = document.getElementById('lyricsBtn');
    const lyricsContainer = document.getElementById('lyricsContainer');
    const lyricsScroll = document.getElementById('lyricsScroll');
    let lyricsOpen = false;

    // Toggle lyrics panel
    lyricsBtn.onclick = ()=>{
      lyricsOpen = !lyricsOpen;
      lyricsContainer.classList.toggle('open', lyricsOpen);
      lyricsBtn.textContent = lyricsOpen ? 'Hide Lyrics' : 'Show Lyrics';
    };

    // Build lyrics HTML
    if (lyrics.length > 0) {
      lyricsScroll.innerHTML = lyrics.map((l, i) => 
        `<div class="lyricLine" data-time="${l.time}" data-index="${i}">${l.text}</div>`
      ).join('');
    } else {
      lyricsScroll.innerHTML = '<div class="lyricsEmpty">No lyrics available</div>';
    }

    const lyricLines = Array.from(document.querySelectorAll('.lyricLine'));

    // Update active line (karaoke style)
    function updateLyrics(currentTime) {
      let activeIndex = 0;
      
      // Find current line
      for (let i = 0; i < lyrics.length; i++) {
        if (currentTime >= lyrics[i].time) {
          activeIndex = i;
        }
      }

      // Apply classes for premium styling
      lyricLines.forEach((line, i) => {
        line.classList.remove('active', 'next');
        if (i === activeIndex) {
          line.classList.add('active');
        } else if (i === activeIndex + 1) {
          line.classList.add('next');
        }
      });

      // Smooth auto-scroll to keep current line centered
      const activeLine = lyricLines[activeIndex];
      if (activeLine && lyricsOpen) {
        const scrollTop = activeLine.offsetTop - lyricsScroll.offsetHeight / 2 + activeLine.offsetHeight / 2;
        lyricsScroll.scrollTo({ top: scrollTop, behavior: 'smooth' });
      }
    }

    // Tap line to seek
    lyricLines.forEach(line => {
      line.onclick = ()=>{
        const time = parseFloat(line.dataset.time);
        ws.seekTo(time / ws.getDuration());
      };
    });

    // Update lyrics as song plays
    ws.on('audioprocess', ()=> updateLyrics(ws.getCurrentTime()));
    ws.on('seek', ()=> updateLyrics(ws.getCurrentTime()));
  </script>
</body>
</html>
